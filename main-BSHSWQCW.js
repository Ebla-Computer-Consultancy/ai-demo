import{$ as T,Da as h,E as x,G as u,Ha as k,Ia as L,Ja as U,L as D,La as Q,Ma as z,N as _,Oa as X,Pa as B,Qa as m,S as K,Sa as q,Va as J,W as C,X as E,Xa as W,Y as p,Ya as Z,_ as Y,_a as $,aa as G,ab as ee,bb as te,c as b,d as f,db as oe,e as M,ea as R,eb as re,fa as I,ga as y,i as w,j as d,ja as P,lb as ie,nb as ne,r as a,ra as v,s as g,sa as N,w as A,wa as F,x as S,xa as H,y as V,za as j}from"./chunk-SCVSWFX6.js";var pe=["video_ref"],me=["recorder"],fe=e=>({loading:e});function ge(e,ue){if(e&1&&p(0,"input",10),e&2){let r=G();_("formControl",r.control)}}var ae=(()=>{class e{video_ref;recorder;onToggle=new V;type="inner";aiSpeechToTextService=a(re);_cd=a(H);service=a(q);route=a(z);control=new $({value:"",disabled:!0});isLoading=!1;STREAM_ID_STORAGE_KEY=m.STREAM_ID_STORAGE_KEY;MESSAGE_TEXT_KEY=m.MESSAGE_TEXT_KEY;AVATAR_IS_RECORDING_KEY=m.AVATAR_IS_RECORDING_KEY;OUTER_AVATAR_IS_ACTIVE_KEY=m.OUTER_AVATAR_IS_ACTIVE_KEY;ask$=new b;constructor(){}ngOnInit(){}ngAfterViewInit(){localStorage.setItem(this.OUTER_AVATAR_IS_ACTIVE_KEY,String(!0)),localStorage.getItem(this.STREAM_ID_STORAGE_KEY)&&this.closeStream(),this.isLoading=!0,this._cd.detectChanges(),this.service.startStream(!0).pipe(d(t=>{let{webrtcData:o}=t.data,{offer:i,iceServers:c}=o,{id:l}=t.data;localStorage.setItem(this.STREAM_ID_STORAGE_KEY,l);let s=new RTCPeerConnection({iceTransportPolicy:"relay",iceServers:c});return s.onicecandidate=n=>{console.log("onicecandidate",n),n.candidate&&this.service.sendCandidate(l,n.candidate).subscribe()},s.onicegatheringstatechange=n=>{console.log("onicegatheringstatechange",n),console.log("srcObject",this.video_ref.nativeElement.srcObject),n.target.iceGatheringState==="complete"&&this.video_ref.nativeElement.paused&&this.video_ref.nativeElement.srcObject&&this.video_ref.nativeElement.play()},s.ontrack=n=>{console.log("ontrack",n);let[O]=n.streams;this.video_ref.nativeElement.srcObject=O},f(s.setRemoteDescription(new RTCSessionDescription(i))).pipe(d(()=>f(s.createAnswer()))).pipe(d(n=>f(s.setLocalDescription(n)).pipe(M(()=>({id:l,answer_:n})))))})).pipe(w(()=>{this.isLoading=!1,this._cd.detectChanges()}),d(({id:t,answer_:o})=>this.service.sendAnswer(t,o))).subscribe()}get isProcessing(){return!!localStorage.getItem(this.MESSAGE_TEXT_KEY)&&!JSON.parse(localStorage.getItem(this.AVATAR_IS_RECORDING_KEY)||"false")}closeStream(){let r=localStorage.getItem(this.STREAM_ID_STORAGE_KEY);r&&(localStorage.removeItem(this.STREAM_ID_STORAGE_KEY),this.service.closeStream(r).subscribe()),this.video_ref.nativeElement.srcObject=null}stopRecording(){this.control.value&&localStorage.setItem(this.MESSAGE_TEXT_KEY,this.control.value),this.reset()}reset(){this.control.reset(),this.control.updateValueAndValidity()}handleSpeechToText(r){this.control.setValue(r)}beforeUnloadHandler(){localStorage.setItem(this.OUTER_AVATAR_IS_ACTIVE_KEY,String(!1)),this.closeStream()}ngOnDestroy(){localStorage.setItem(this.OUTER_AVATAR_IS_ACTIVE_KEY,String(!1)),this.closeStream()}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=g({type:e,selectors:[["app-ai-avatar"]],viewQuery:function(t,o){if(t&1&&(R(pe,5),R(me,5)),t&2){let i;I(i=y())&&(o.video_ref=i.first),I(i=y())&&(o.recorder=i.first)}},hostBindings:function(t,o){t&1&&T("beforeunload",function(c){return o.beforeUnloadHandler(c)},!1,x)},inputs:{type:"type"},outputs:{onToggle:"onToggle"},standalone:!0,features:[v],decls:11,vars:7,consts:[["video_ref",""],["recorder",""],[1,"ai-video-controls-container","vh-100","d-flex","align-items-end"],["id","video","autoplay",""],[1,"spinner",3,"ngClass"],[1,"form","p-3","flex-grow-1"],[1,"container"],["id","message-form",1,"d-flex","align-items-cener"],[1,"me-2"],[3,"onRecordReady","onStopRecording","disabled","isProcessing","recordOnHold"],["type","text","id","user-message","placeholder","Type your message...",1,"form-control-sm","form-control",3,"formControl"]],template:function(t,o){if(t&1){let i=Y();C(0,"div",2),p(1,"video",3,0)(3,"div",4),C(4,"div",5)(5,"div",6)(6,"form",7)(7,"div",8)(8,"audio-recorder",9,1),T("onRecordReady",function(l){return A(i),S(o.handleSpeechToText(l))})("onStopRecording",function(){return A(i),S(o.stopRecording())}),E()(),D(10,ge,1,1,"input",10),E()()()()}if(t&2){let i=P(9);u(3),_("ngClass",N(5,fe,o.isLoading)),u(5),_("disabled",o.isLoading)("isProcessing",o.isProcessing)("recordOnHold",!0),u(2),K(i.isRecording?10:-1)}},dependencies:[h,j,oe,ee,J,W,Z,te,ie],styles:["video[_ngcontent-%COMP%]{width:100vw;height:100vh;position:fixed;top:0;left:0;z-index:-1;background:#c1c1c1!important}.ai-video-controls-container[_ngcontent-%COMP%]{position:relative}.ai-video-controls-container[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{width:41px;height:41px;position:absolute;top:calc(50% - 20px);left:calc(50% - 20px);z-index:1;border-radius:50%;border:solid 3px transparent;border-left-color:var(--bs-primary);border-right-color:var(--bs-primary);animation:_ngcontent-%COMP%_spin 2s linear infinite .5s;opacity:0}.ai-video-controls-container[_ngcontent-%COMP%]   .spinner.loading[_ngcontent-%COMP%]{opacity:1}.ai-video-controls-container[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:block;width:37px;height:37px;position:absolute;top:2px;left:2px;background:red;border-radius:50%}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})}return e})();var se=[{path:"",pathMatch:"full",redirectTo:"/ai-service/ai-service-home"},{path:"ai-service",loadChildren:()=>import("./chunk-6DXFZPGA.js").then(e=>e.AiServicesModule)},{path:"ai-avatar",component:ae}];var ce={providers:[F({eventCoalescing:!0}),k(L()),X(se)]};var le=(()=>{class e{store=a(ne);ngOnInit(){}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=g({type:e,selectors:[["app-root"]],standalone:!0,features:[v],decls:1,vars:0,template:function(t,o){t&1&&p(0,"router-outlet")},dependencies:[Q,B,h]})}return e})();U(le,ce).catch(e=>console.error(e));
