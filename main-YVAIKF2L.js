import{$a as ie,Da as k,E as x,Ea as L,Fa as U,G as _,Ha as Q,Ia as z,K as D,Ka as X,La as B,M as u,Ma as m,Oa as q,Q as K,Qa as J,Sa as W,Ta as Z,U as C,V as E,Va as $,W as p,Xa as ee,Y,Ya as te,Z as T,_ as G,_a as oe,c as b,ca as R,d as f,da as I,e as M,ea as y,fa as P,gb as re,i as w,j as l,na as v,oa as N,r as d,s as g,sa as F,ta as H,va as j,w as A,x as S,y as V,za as h}from"./chunk-RW5Y6FNS.js";var de=["video_ref"],pe=["recorder"],me=e=>({loading:e});function fe(e,ge){if(e&1&&p(0,"input",10),e&2){let i=G();u("formControl",i.control)}}var ne=(()=>{class e{video_ref;recorder;onToggle=new V;type="inner";aiSpeechToTextService=d(ie);_cd=d(H);service=d(q);route=d(z);control=new $({value:"",disabled:!0});isLoading=!1;STREAM_ID_STORAGE_KEY=m.STREAM_ID_STORAGE_KEY;MESSAGE_TEXT_KEY=m.MESSAGE_TEXT_KEY;AVATAR_IS_RECORDING_KEY=m.AVATAR_IS_RECORDING_KEY;OUTER_AVATAR_IS_ACTIVE_KEY=m.OUTER_AVATAR_IS_ACTIVE_KEY;ask$=new b;constructor(){}ngOnInit(){}ngAfterViewInit(){localStorage.setItem(this.OUTER_AVATAR_IS_ACTIVE_KEY,String(!0)),localStorage.getItem(this.STREAM_ID_STORAGE_KEY)&&this.closeStream(),this.isLoading=!0,this._cd.detectChanges(),this.service.startStream().pipe(l(t=>{let{webrtcData:o}=t.data,{offer:r,iceServers:s}=o,{id:c}=t.data;localStorage.setItem(this.STREAM_ID_STORAGE_KEY,c);let a=new RTCPeerConnection({iceTransportPolicy:"relay",iceServers:s});return a.onicecandidate=n=>{console.log("onicecandidate",n),n.candidate&&this.service.sendCandidate(c,n.candidate).subscribe()},a.onicegatheringstatechange=n=>{console.log("onicegatheringstatechange",n),console.log("srcObject",this.video_ref.nativeElement.srcObject),n.target.iceGatheringState==="complete"&&this.video_ref.nativeElement.paused&&this.video_ref.nativeElement.srcObject&&this.video_ref.nativeElement.play()},a.ontrack=n=>{console.log("ontrack",n);let[O]=n.streams;this.video_ref.nativeElement.srcObject=O},f(a.setRemoteDescription(new RTCSessionDescription(r))).pipe(l(()=>f(a.createAnswer()))).pipe(l(n=>f(a.setLocalDescription(n)).pipe(M(()=>({id:c,answer_:n})))))})).pipe(w(()=>{this.isLoading=!1,this._cd.detectChanges()}),l(({id:t,answer_:o})=>this.service.sendAnswer(t,o))).subscribe()}get isProcessing(){return!!localStorage.getItem(this.MESSAGE_TEXT_KEY)&&!JSON.parse(localStorage.getItem(this.AVATAR_IS_RECORDING_KEY)||"false")}closeStream(){let i=localStorage.getItem(this.STREAM_ID_STORAGE_KEY);i&&(localStorage.removeItem(this.STREAM_ID_STORAGE_KEY),this.service.closeStream(i).subscribe()),this.video_ref.nativeElement.srcObject=null}stopRecording(){this.control.value&&localStorage.setItem(this.MESSAGE_TEXT_KEY,this.control.value),this.reset()}reset(){this.control.reset(),this.control.updateValueAndValidity()}handleSpeechToText(i){this.control.setValue(i)}beforeUnloadHandler(){localStorage.setItem(this.OUTER_AVATAR_IS_ACTIVE_KEY,String(!1)),this.closeStream()}ngOnDestroy(){localStorage.setItem(this.OUTER_AVATAR_IS_ACTIVE_KEY,String(!1)),this.closeStream()}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=g({type:e,selectors:[["app-ai-avatar"]],viewQuery:function(t,o){if(t&1&&(R(de,5),R(pe,5)),t&2){let r;I(r=y())&&(o.video_ref=r.first),I(r=y())&&(o.recorder=r.first)}},hostBindings:function(t,o){t&1&&T("beforeunload",function(s){return o.beforeUnloadHandler(s)},!1,x)},inputs:{type:"type"},outputs:{onToggle:"onToggle"},standalone:!0,features:[v],decls:11,vars:7,consts:[["video_ref",""],["recorder",""],[1,"ai-video-controls-container","vh-100","d-flex","align-items-end"],["id","video","autoplay",""],[1,"spinner",3,"ngClass"],[1,"form","p-3","flex-grow-1"],[1,"container"],["id","message-form",1,"d-flex","align-items-cener"],[1,"me-2"],[3,"onRecordReady","onStopRecording","disabled","isProcessing","recordOnHold"],["type","text","id","user-message","placeholder","Type your message...",1,"form-control-sm","form-control",3,"formControl"]],template:function(t,o){if(t&1){let r=Y();C(0,"div",2),p(1,"video",3,0)(3,"div",4),C(4,"div",5)(5,"div",6)(6,"form",7)(7,"div",8)(8,"audio-recorder",9,1),T("onRecordReady",function(c){return A(r),S(o.handleSpeechToText(c))})("onStopRecording",function(){return A(r),S(o.stopRecording())}),E()(),D(10,fe,1,1,"input",10),E()()()()}if(t&2){let r=P(9);_(3),u("ngClass",N(5,me,o.isLoading)),_(5),u("disabled",o.isLoading)("isProcessing",o.isProcessing)("recordOnHold",!0),_(2),K(r.isRecording?10:-1)}},dependencies:[h,j,oe,ee,J,W,Z,te,re],styles:["video[_ngcontent-%COMP%]{width:100vw;height:100vh;position:fixed;top:0;left:0;z-index:-1;background:#c1c1c1!important}.ai-video-controls-container[_ngcontent-%COMP%]{position:relative}.ai-video-controls-container[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{width:41px;height:41px;position:absolute;top:calc(50% - 20px);left:calc(50% - 20px);z-index:1;border-radius:50%;border:solid 3px transparent;border-left-color:var(--bs-primary);border-right-color:var(--bs-primary);animation:_ngcontent-%COMP%_spin 2s linear infinite .5s;opacity:0}.ai-video-controls-container[_ngcontent-%COMP%]   .spinner.loading[_ngcontent-%COMP%]{opacity:1}.ai-video-controls-container[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:block;width:37px;height:37px;position:absolute;top:2px;left:2px;background:red;border-radius:50%}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})}return e})();var ae=[{path:"",pathMatch:"full",redirectTo:"/ai-service/ai-service-home"},{path:"ai-service",loadChildren:()=>import("./chunk-JFOT3PFD.js").then(e=>e.AiServicesModule)},{path:"ai-avatar",component:ne}];var se={providers:[F({eventCoalescing:!0}),k(L()),X(ae)]};var ce=(()=>{class e{ngOnInit(){}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=g({type:e,selectors:[["app-root"]],standalone:!0,features:[v],decls:1,vars:0,template:function(t,o){t&1&&p(0,"router-outlet")},dependencies:[Q,B,h]})}return e})();U(ce,se).catch(e=>console.error(e));
